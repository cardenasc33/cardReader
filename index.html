<!DOCTYPE html>
<html>
    <head>
    
    </head>
    <body>
        
        <br></br>
        <input id = "text" type="text" oninput="getText()">
       
        <p id = "total"> Total Characters: 0</p>
        <p id = "status"> Status: Please Swipe Card</p>
        <p id = "uinID">UIN: </p>
        <p id="prefix">Prefix: </p>
        <button id = "resetButton" onclick="resetFields()" >Reset</button> 
        <br></br>
        <div id = "userInfo" ><u>User Info: </u></div>

        <!-- Manual Entery and Upload of User Data -->
        
        <p>Manually enter UIN if card swipe not applicable:</p>
        <form action="/action_page.php">
            UIN:<br>
            <input type="text" name="uinInput" value="" required minLength="9" maxLength="9">
            <br>
            <input type="submit" id = "uploadBtn" value="Upload" required>
          </form> 

    </body>
   
   <script>
   
        
        /* Resets all the fields when reset button is pressed */
        function resetFields(){
            document.getElementById("text").value = "";
            document.getElementById("total").innerHTML = "Total Characters: 0";
            document.getElementById("status").innerHTML = "Status: Please Swipe Card";
            document.getElementById("uinID").innerHTML = "UIN: ";
            document.getElementById("prefix").innerHTML = "Prefix: ";
            document.getElementById("userInfo").innerHTML = "<u>User Info: </u>";
        }

        function getText(){
            var textInput = document.getElementById('text').value;
            textInput = textInput.replace(/\s/g, ''); 
            count(textInput);
            
        }
        function count(textInput){
            var total = textInput;
            total = total.replace(/\s/g, '');
            document.getElementById("total").innerHTML="Total Characters: " + (total.length);
            
            statusUpdate(total.length , total); 

        }
            
        function statusUpdate(len , text){ //Param is the number of characters in the input field
    
            var maxLength = 79; //Total amount of characters for a successful card swipe
            var prefix = text.toString().substring(0, 2); //obtains the prefix characters of the input (ex. %B)  

            document.getElementById("prefix").innerHTML= "Prefix: " + prefix;

                if (len == 0){ 
                    document.getElementById("status").innerHTML="Status: " + "Please Swipe Card";
                }
                if (len == maxLength && prefix == "%B"){
                    document.getElementById("status").innerHTML="Status: " + "Success"; //Card was read properly
                    getUIN(text); //Calls the function getUIN() to obtain the UIN substring
                }
                else{
                    document.getElementById("status").innerHTML="Status: " + "Error, please swipe again"; //Card did NOT read properly
                
                }
        }

        /* called if UIN is obtainable 
         * searches UIN in the database,
         * displays info for matching UIN
         * 
         */ 
         function getUIN(text){
            var uin = text.substring(54, 63); //Obtains the string of the UIN
            document.getElementById("uinID").innerHTML="UIN: " + uin;

            //AJAX call , searches UIN, pull info 
            loadDoc(uin); //loads data from json file
        }

        /*
         * Opens the JSON file and does a 
         * search to find a match to the passed UIN.
         * Displays appropriate information based on 
         * search results
         */
        function loadDoc(uinNum){
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    
                    var json = JSON.parse(this.responseText);
                    
                    var i;
                    
                    /* Searches the JSON file for matching UIN number */
                    for (i = 0; i < json.length; i++){

                        /* When match is found, display information about the user associated to the UIN */
                        if (json[i].uin == uinNum){ 
                            document.getElementById("userInfo").innerHTML = "<u>User Info: </u>"; 
                            document.getElementById("userInfo").innerHTML += "<br>Name: " + json[i].studentInfo["firstName"]  + " " + json[i].studentInfo["middleName"] + " " + json[i].studentInfo["lastName"];
                            document.getElementById("userInfo").innerHTML += "<br>UIN: " + json[i].uin;
                            document.getElementById("userInfo").innerHTML += "<br>RSVP: " + json[i].studentInfo["rsvpStatus"];
                            break; //Match is found, stop search
                        }
                        else{
                            document.getElementById("userInfo").innerHTML = "<u>User Info: </u>" + "** User Not Found **";
                        }     
                    }
    
                }
            };
            xhttp.open("GET", "test1.json", true);
            xhttp.send();
        }



    </script>


</html>